# 2K1000上板过程问题

## UART地址设置

UART0寄存器（映射）基址：0x8000_0000_1fe2_0000

出处：U-Boot源码解析（龙芯版）章节5.3.2。指向U-Boot源码：u-boot-2022.04-2k1000
```asm
/arch/loongarch/mach-loongson/ls2k100/lowlevel_init.S:394

#define UART_REF_CLK	125000000
#define UART_DIV_HI	 (((UART_REF_CLK + (115200*8)) / (115200*16)) >> 8)
#define UART_DIV_LO	(((UART_REF_CLK + (115200*8)) / (115200*16)) & 0xff)
ENTRY(init_serial)
	or  a4, ra, zero      /*返回地址写入a4*/

	li.d	a0, CONSOLE_BASE_ADDR
    /*UART0寄存器（映射）基址：0x8000_0000_1fe2_0000*/
    /*/include/configs/loongson_2k1000.h*/
    /*/arch/loongarch/mach-loongson/include/mach/ls2k1000/ls2k1000.h*/
```

## NAND_BASE与DMA_ADDR

NAND_BASE: usize = 0x1fe2_6000 | HIGH_BASE_EIGHT;
DMA_ADDR: usize = 0x1fe0_0c00 | HIGH_BASE_EIGHT;

出处：U-Boot源码解析（龙芯版）章节9.5.1。

通过搜索NAND找到的，在U-Boot源码中也得到了验证，观察其中的reg项可以找到地址。

在2K500：
```
arch/loongarch/dts/ls2k500.dtsi

577行：
nand: nand-controller@1ff58000 {
    compatible = "loongson,ls-nand";
    reg = <0 0x1ff58000 0 0x4000>;
    pinctrl-names = "default";
    pinctrl-0 = <&nand_pins>;
    dmas = <&dma0 0>;
    dma-names = "nand-rw";
    nand-cs-origin = <0>;
    nand-ecc-algo = "bch";  // "bch", "none"
    nand-ecc-strength = <4>;
    status = "disabled";
};

342行：
dma0: dma@1fe10c00 {
    compatible = "loongson,ls2k500-dma";
    reg = <0 0x1fe10c00 0 0x4>;
    dma-cfg = <&dmacfg 0 LS_DMA_OWNER_NAND>; // arg[0]: channel id  arg[1]: dma owner
    #dma-cells = <1>;
    dma-channels = <1>;
    dma-requests = <1>;
};
```
在2K1000：
```
arch/loongarch/dts/ls2k1000.dtsi

505行：
nand: nand-controller@1fe26000 {
    compatible = "loongson,ls-nand";
    reg = <0 0x1fe26000 0 0x44>;
    pinctrl-names = "default";
    pinctrl-0 = <&pinmux_nand_nand>;
    dmas = <&dma0 0>;
    dma-names = "nand-rw";
    nand-cs-origin = <2>;
    nand-ecc-algo = "bch";  // "bch", "none"
    nand-ecc-strength = <4>;
    status = "disabled";
};

379行：
dma0: dma@1fe00c00 {
    compatible = "loongson,ls2k1000-dma";
    reg = <0 0x1fe00c00 0 0x8>;
    dma-cfg = <&dmacfg 0 LS_DMA_OWNER_NAND>; // arg[0]: channel id  arg[1]: dma owner
    #dma-cells = <1>;
    dma-channels = <1>;
    dma-requests = <1>;
};
```

## 2k1000上板实际流程

### 配置环境

需要的环境有：**串口监视器（可选择使用minicom/xshell/tabby等），tftp服务器**

#### 串口监视器的配置

Windows下：推荐使用tabby，xshell等存在GUI的串口监视器，直接官网下载安装包即可，串口将自动识别

Linux下：仍推荐使用Tabby，配置minicom的方法将在下面给出

##### 配置minicom

首先下载minicom，基于debian发行版本安装指令如下：`sudo apt install minicom`

对于minicom，其帮助页面如下
```bash
Usage: minicom [OPTION]... [configuration]
A terminal program for Linux and other unix-like systems.

  -b, --baudrate         : set baudrate (ignore the value from config)
  -D, --device           : set device name (ignore the value from config)
  -s, --setup            : enter setup mode
  -o, --noinit           : do not initialize modem & lockfiles at startup
  -m, --metakey          : use meta or alt key for commands
  -M, --metakey8         : use 8bit meta key for commands
  -l, --ansi             : literal; assume screen uses non IBM-PC character set
  -L, --iso              : don't assume screen uses ISO8859
  -w, --wrap             : Linewrap on
  -H, --displayhex       : display output in hex
  -z, --statline         : try to use terminal's status line
  -7, --7bit             : force 7bit mode
  -8, --8bit             : force 8bit mode
  -c, --color=on/off     : ANSI style color usage on or off
  -a, --attrib=on/off    : use reverse or highlight attributes on or off
  -t, --term=TERM        : override TERM environment variable
  -S, --script=SCRIPT    : run SCRIPT at startup
  -d, --dial=ENTRY       : dial ENTRY from the dialing directory
  -p, --ptty=TTYP        : connect to pseudo terminal
  -C, --capturefile=FILE : start capturing to FILE
  --capturefile-buffer-mode=MODE : set buffering mode of capture file
  -F, --statlinefmt      : format of status line
  -R, --remotecharset    : character set of communication partner
  -v, --version          : output version information and exit
  -h, --help             : show help
  configuration          : configuration file to use

These options can also be specified in the MINICOM environment variable.
```

故可以采用`-v`检查安装是否正确

正确安装后，请在`/dev`目录下找到对应的串口管理文件，通常格式为`ttyUSBx`

然后使用`minicom -D {设备名称}`对设备进行链接

---

#### tftp服务器的配置

首先使用apt安装tftp服务器，包名称tftpd-hpa

随后在etc/default中找到tftpd.service的文件，将服务器文件夹设置为目标文件夹

随后使用`setenv ipaddr <ip地址>`对开发板进行配网

*具体配置思路类似于QEMU*

### 上板

使用串口监视器链接开发板，轻按reset按钮重置开发板

在开发板重启时进入uboot界面，使用ping命令检查开发板与主机间网口是否通畅，如若通常，应提示

`pinging <ip address>,<ip address> is alive`

随后使用命令`tftp <镜像名称>`进行烧写，如有特殊需要可以`?`在uboot界面跳出帮助手册

镜像烧写完全后，使用`bootm`自动引导镜像

### 可能产生的问题

#### Q1 网口通信不畅

linux端检查网络设置并确保**开发板设置网口ip和主机设置网口ip在一个网段中**

**重要提示**：开发板的uboot系统为了轻量化并没有完整的网络功能，甚至tftp端口都是写死为:69的

#### Q2 无法正确引导镜像（引导之后没有输出）

请检查您的启动地址设置，如果采用我们的cmake脚本的话，默认地址应为
```sh
LA_ENTRY_POINT = 0x9000000090000000
LA_LOAD_ADDR = 0x9000000090000000
```
您可以如此使用`tftp <LOAD_ADDR> <Image>`来对镜像加载起始地址进行设置，*tftp具体用法请在uboot界面输入`？ tftp`*

**重要提示**：请注意uImage在LOAD_ADDR与ENTRY_POINT存在64B的差距，具体存放了镜像信息

```c
typedef struct image_header {
    __be32		ih_magic;	/* Image Header Magic Number: 镜像魔数, 0x27051956为 uimage的头部开始值 */
	__be32		ih_hcrc;	/* Image Header CRC Checksum: 整个64字节头的crc校验码 */
	__be32		ih_time;	/* Image Creation Timestamp: uImage的创建时间戳 */
	__be32		ih_size;	/* Image Data Size: zImage镜像的大小 */
	__be32		ih_load;	/* Data Load  Address: 内核加载地址 */
	__be32		ih_ep;		/* Entry Point Address: zImage的入口位置 = lode + 64，也是内核运行地址，“theKernel”指向该地址，说明这里藏着进入第一个函数-解压函数 */
	__be32		ih_dcrc;	/* Image Data CRC Checksum: 整个zImage的crc校验码 */
	uint8_t		   ih_os;		/* Operating System: 操作系统代码 */
	uint8_t		   ih_arch;	/* CPU architecture: 芯片类型,cpu架构 */
	uint8_t		   ih_type;	/* Image Type: 镜像类型 */
	uint8_t		   ih_comp;	/* Compression Type: 压缩类型 */
	uint8_t		   ih_name[IH_NMLEN];	/* Image Name: 32字节的名字 */
} image_header_t;
```

### 参考文章

<https://blog.csdn.net/lpwsw/article/details/121083920>
<https://blog.csdn.net/u012964600/article/details/135693068>